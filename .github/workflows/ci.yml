# FDA Tools - Continuous Integration Pipeline
# Runs on every PR and push to main branch
# Implements comprehensive quality gates: linting, testing, security, coverage

name: Continuous Integration

on:
  push:
    branches:
      - master
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'
      - 'EXAMPLE_OUTPUT/**'
      - 'archives/**'

  pull_request:
    branches:
      - master
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'EXAMPLE_OUTPUT/**'
      - 'archives/**'

  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow tests (API calls)'
        required: false
        type: boolean
        default: false
      coverage_threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 80

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v1
  MIN_COVERAGE: 80

jobs:
  # ==========================================================================
  # Job 1: Code Quality & Linting
  # ==========================================================================
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            plugins/fda_tools/bridge/requirements.txt

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ env.CACHE_VERSION }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev]"
          pip install pre-commit

      - name: Run Ruff linter
        run: |
          echo "::group::Ruff Linting"
          ruff check plugins/fda_tools/ --output-format=github
          echo "::endgroup::"

      - name: Run Ruff formatter check
        run: |
          echo "::group::Ruff Format Check"
          ruff format --check plugins/fda_tools/
          echo "::endgroup::"

      - name: Run Black formatter check
        run: |
          echo "::group::Black Format Check"
          black --check plugins/fda_tools/lib plugins/fda_tools/scripts plugins/fda_tools/tests
          echo "::endgroup::"

      - name: Check YAML syntax
        run: |
          echo "::group::YAML Validation"
          yamllint -c .yamllint.yml .github/ docker-compose.yml || true
          echo "::endgroup::"

      - name: Check JSON syntax
        run: |
          echo "::group::JSON Validation"
          find plugins/fda-tools -name "*.json" -not -path "*/node_modules/*" -exec python -m json.tool {} \; > /dev/null
          echo "::endgroup::"

      - name: Run docstring coverage check
        run: |
          echo "::group::Docstring Coverage"
          interrogate -vv --fail-under=75 \
            --ignore-init-method \
            --ignore-init-module \
            --ignore-nested-functions \
            plugins/fda_tools/lib plugins/fda_tools/scripts || true
          echo "::endgroup::"

  # ==========================================================================
  # Job 2: Type Checking
  # ==========================================================================
  typecheck:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true  # Non-blocking

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run mypy type checking
        run: |
          echo "::group::Type Checking"
          mypy plugins/fda_tools/lib/ --config-file=pyproject.toml || true
          echo "::endgroup::"

      - name: Upload mypy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-report
          path: .mypy_cache/
          retention-days: 7

  # ==========================================================================
  # Job 3: Security Scanning
  # ==========================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install bandit[toml] safety detect-secrets pip-licenses

      - name: Run Bandit security scanner
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r plugins/fda_tools/lib plugins/fda_tools/scripts \
            -ll -f json -o bandit-report.json || true
          bandit -r plugins/fda_tools/lib plugins/fda_tools/scripts \
            -ll --ini .bandit
          echo "::endgroup::"

      - name: Run Safety vulnerability check
        run: |
          echo "::group::Safety Vulnerability Check"
          safety check --json --output safety-report.json || true
          safety check --bare || echo "::warning::Vulnerable dependencies found"
          echo "::endgroup::"

      - name: Run detect-secrets
        run: |
          echo "::group::Secret Detection"
          detect-secrets scan --baseline .secrets.baseline
          echo "::endgroup::"

      - name: Run license compliance check
        run: |
          echo "::group::License Compliance Check"
          pip-licenses --format=json --output-file=license-report.json || true
          # Flag GPL/AGPL/LGPL licenses that require review
          if pip-licenses --format=plain | grep -E "GPL|AGPL|LGPL"; then
            echo "::warning::Copyleft licenses detected — manual review required"
          else
            echo "License check passed: no copyleft licenses found"
          fi
          echo "::endgroup::"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'plugins/fda-tools'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            trivy-results.sarif
            license-report.json
          retention-days: 30

  # ==========================================================================
  # Job 4: Unit Tests
  # ==========================================================================
  test:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        include:
          - os: macos-latest
            python-version: '3.11'
          - os: windows-latest
            python-version: '3.11'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            tesseract-ocr \
            tesseract-ocr-eng \
            libxml2-dev \
            libxslt1-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install tesseract

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[optional,test]"

      - name: Run fast unit tests
        run: |
          pytest plugins/fda_tools/tests/ \
            -m "not slow and not e2e and not api and not e2e_integration" \
            --cov=plugins/fda_tools/lib \
            --cov=plugins/fda_tools/scripts \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            --cov-report=html \
            --junit-xml=junit-report.xml \
            -v

      - name: Run slow/API tests (on-demand)
        if: github.event.inputs.run_slow_tests == 'true'
        env:
          OPENFDA_API_KEY: ${{ secrets.OPENFDA_API_KEY }}
        run: |
          pytest plugins/fda_tools/tests/ \
            -m "slow or api" \
            -v

      - name: Check coverage threshold
        run: |
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          THRESHOLD=${{ github.event.inputs.coverage_threshold || env.MIN_COVERAGE }}
          echo "Coverage: ${COVERAGE}%"
          echo "Threshold: ${THRESHOLD}%"
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            junit-report.xml
            htmlcov/
            coverage.xml
          retention-days: 30

  # ==========================================================================
  # Job 5: Integration Tests
  # ==========================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: fda_tools_test
          POSTGRES_USER: fdatools
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[optional,test]"

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://fdatools:test_password@localhost:5432/fda_tools_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest plugins/fda_tools/tests/ \
            -m "integration" \
            -v || true

  # ==========================================================================
  # Job 6: Build & Package Validation
  # ==========================================================================
  build:
    name: Build & Package Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build twine

      - name: Build distribution packages
        run: |
          echo "::group::Building Package"
          python -m build
          echo "::endgroup::"

      - name: Check distribution metadata
        run: |
          echo "::group::Checking Package Metadata"
          twine check dist/*
          echo "::endgroup::"

      - name: List distribution contents
        run: |
          echo "::group::Distribution Files"
          ls -lh dist/
          echo "::endgroup::"

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-distributions
          path: dist/
          retention-days: 90

  # ==========================================================================
  # Job 7: Docker Build & Scan
  # ==========================================================================
  docker:
    name: Docker Build & Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: fda-tools:test
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            PYTHON_VERSION=3.11
            ENVIRONMENT=testing
            ENABLE_OPTIONAL_DEPS=true

      - name: Test Docker image health
        run: |
          docker run --rm fda-tools:test health --verbose

      - name: Run Trivy vulnerability scanner on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'fda-tools:test'
          format: 'sarif'
          output: 'trivy-docker-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Docker results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-docker-results.sarif'

      - name: Run Snyk Container Security scan
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: fda-tools:test
          args: --severity-threshold=high

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ==========================================================================
  # Job 8: Performance Benchmarks (non-blocking)
  # Runs benchmarks and saves results as artifacts; compares against stored
  # baselines when available.  Does not block CI on first run (no baselines).
  # ==========================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Run on main branch pushes and PRs; never blocks CI
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Restore stored baselines (if any)
        uses: actions/cache@v4
        with:
          path: ~/.fda-510k-data/.performance
          key: perf-baselines-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            perf-baselines-${{ runner.os }}-refs/heads/master

      - name: Run benchmarks
        id: benchmarks
        run: |
          python3 -m fda_tools.scripts.benchmark_runner \
            --output benchmark-results.json \
            --warn-ok \
            || echo "::warning::Performance regressions detected — see benchmark-results.json"

      - name: Record baselines (master branch only)
        if: github.ref == 'refs/heads/master'
        run: |
          python3 -m fda_tools.scripts.benchmark_runner --record
          echo "Baselines updated for master branch"

      - name: Save baselines (master branch only)
        if: github.ref == 'refs/heads/master'
        uses: actions/cache/save@v4
        with:
          path: ~/.fda-510k-data/.performance
          key: perf-baselines-${{ runner.os }}-${{ github.ref }}

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.json
          retention-days: 90

  # ==========================================================================
  # Job 9: CI Summary & Status
  # ==========================================================================
  ci-success:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, typecheck, security, test, integration, build, docker]

    steps:
      - name: Check job statuses
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "TypeCheck: ${{ needs.typecheck.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Integration: ${{ needs.integration.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Docker: ${{ needs.docker.result }}"

      - name: Verify required jobs passed
        if: |
          needs.lint.result != 'success' ||
          needs.security.result != 'success' ||
          needs.test.result != 'success' ||
          needs.build.result != 'success' ||
          needs.docker.result != 'success'
        run: |
          echo "::error::One or more required CI jobs failed"
          exit 1

      - name: CI Pipeline Success
        run: |
          echo "::notice::All CI checks passed successfully!"
