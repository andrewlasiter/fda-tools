# FDA-256  [DESK-003] Code-signed Electron installer CI
# ========================================================
# Triggered on semver tags (e.g. v1.2.3-desktop).
# Builds signed installers for Windows, macOS, and Linux,
# then attaches them to the GitHub Release.
#
# Required GitHub Secrets
# -----------------------
#   WIN_CSC_LINK          Base64-encoded PKCS#12 (.p12) code-signing certificate
#   WIN_CSC_KEY_PASSWORD  Password for the PKCS#12 file
#   APPLE_ID              Apple Developer account email
#   APPLE_APP_SPECIFIC_PASSWORD  App-specific password for notarisation
#   APPLE_TEAM_ID         Apple Developer Team ID

name: Electron Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+-desktop'

permissions:
  contents: write

jobs:
  # ── Windows (signed NSIS installer) ──────────────────────────────────────────
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: desktop/package-lock.json
      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci
      - name: Build signed Windows installer
        working-directory: desktop
        env:
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run dist -- --win --publish always
      - uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: desktop/dist/*.exe
          retention-days: 7

  # ── macOS (signed + notarised DMG) ───────────────────────────────────────────
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: desktop/package-lock.json
      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci
      - name: Build signed + notarised macOS DMG
        working-directory: desktop
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run dist -- --mac --publish always
      - uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: desktop/dist/*.dmg
          retention-days: 7

  # ── Linux (AppImage + .deb) ───────────────────────────────────────────────────
  build-linux:
    name: Build Linux Packages
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: desktop/package-lock.json
      - name: Install system dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y -q rpm fakeroot
      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci
      - name: Build Linux packages
        working-directory: desktop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run dist -- --linux --publish always
      - uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            desktop/dist/*.AppImage
            desktop/dist/*.deb
          retention-days: 7

  # ── Verify all platform builds passed ────────────────────────────────────────
  verify-release:
    name: Verify Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    timeout-minutes: 5
    steps:
      - name: All platform builds passed
        run: echo "All signed installer builds completed successfully."
