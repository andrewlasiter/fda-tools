# Audit Logging Standard

## Purpose

Provides a regulatory audit trail for all autonomous decisions made by the FDA Predicate Assistant plugin. Designed for traceability per 21 CFR Part 11 principles — every automated decision is logged with timestamp, rationale, and data sources.

## Log File Location

- **Per-command log**: `$PROJECT_DIR/audit_log.jsonl` (append-only, one JSON object per line)
- **Pipeline consolidated log**: `$PROJECT_DIR/pipeline_audit.json` (written at pipeline completion)
- **CLI tool**: `$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py` (validates and appends entries)

## Schema

Each audit log entry is a single JSON object on one line:

```json
{
  "timestamp": "2026-02-09T12:00:00Z",
  "command": "pathway",
  "version": "5.20.0",
  "mode": "interactive",
  "action": "pathway_recommended",
  "entry_id": "a1b2c3d4",
  "subject": "OVE",
  "decision": "Traditional 510(k)",
  "rationale": "Selected Traditional 510(k) (score 87/100). 45 existing predicates, strong guidance coverage, no novel features.",
  "confidence_score": 87,
  "decision_type": "auto",
  "alternatives_considered": ["Traditional 510(k)", "Special 510(k)", "Abbreviated 510(k)", "De Novo", "PMA"],
  "exclusion_records": [
    {"subject": "Special 510(k)", "reason": "No prior clearance provided. Score: 30/100.", "data_sources": ["openFDA classification"]},
    {"subject": "De Novo", "reason": "45 existing clearances for OVE. Score: 15/100.", "data_sources": ["openFDA 510k"]},
    {"subject": "PMA", "reason": "Device is Class II. Score: 10/100.", "data_sources": ["openFDA classification"]},
    {"subject": "Abbreviated 510(k)", "reason": "No device-specific guidance found. Score: 35/100.", "data_sources": ["fda-guidance-index.md"]}
  ],
  "score_breakdown": {"Traditional": 87, "Special": 30, "Abbreviated": 35, "De Novo": 15, "PMA": 10},
  "data_sources": ["openFDA classification", "openFDA 510k", "fda-guidance-index.md"],
  "files_read": ["~/fda-510k-data/projects/OVE_2026/review.json"],
  "files_written": [],
  "warnings": [],
  "error": null
}
```

## Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `timestamp` | ISO 8601 string | When the action occurred |
| `command` | string | Which plugin command generated this entry |
| `version` | string | Plugin version (for schema evolution) |
| `mode` | string | "full-auto", "auto", "interactive", or "pipeline" |
| `action` | string | What happened (see Action Types below) |

## Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `entry_id` | string | Unique entry identifier (auto-generated by fda_audit_logger.py) |
| `subject` | string | The entity acted upon (K-number, product code, file path) |
| `decision` | string | The decision made (accepted, rejected, deferred, skipped) |
| `rationale` | string | Human-readable explanation of why this decision was made |
| `confidence_score` | number | Confidence score if applicable |
| `data_sources` | string[] | External data sources consulted |
| `files_read` | string[] | Input files read |
| `files_written` | string[] | Output files written or modified |
| `warnings` | string[] | Any warnings generated |
| `error` | string | Error message if the action failed |
| `duration_ms` | number | How long the action took |
| `metadata` | object | Command-specific additional data |
| `alternatives_considered` | string[] | ALL options evaluated (including the chosen one) |
| `exclusion_records` | object[] | For each rejected alternative: `{subject, reason, data_sources}` |
| `decision_type` | string | `"auto"` / `"manual"` / `"deferred"` |
| `score_breakdown` | object | Component-level scoring (command-specific) |
| `parent_entry_id` | string | Entry ID of parent decision for cross-command linking (v5.22.0) |
| `related_entries` | string[] | Entry IDs of related decisions across commands (v5.22.0) |

## Action Types

### Review Command
- `predicate_accepted` — Predicate accepted (with score and rationale)
- `predicate_rejected` — Predicate rejected (with reason)
- `predicate_deferred` — Predicate deferred for manual review
- `predicate_reclassified` — Predicate reclassified from original extraction
- `review_completed` — Full review session completed

### Pipeline Command
- `pipeline_started` — Pipeline execution began
- `step_started` — Individual step began
- `step_completed` — Individual step completed successfully
- `step_failed` — Individual step failed (with error)
- `step_skipped` — Step skipped (output already exists)
- `step_degraded` — Step completed with degraded output
- `pipeline_completed` — Pipeline finished (with summary)
- `pipeline_halted` — Pipeline halted due to critical failure

### Pre-Sub / Outline Commands
- `placeholder_resolved` — A [INSERT:] placeholder was auto-filled
- `placeholder_converted` — A [INSERT:] was converted to [TODO:]
- `data_synthesized` — Data was synthesized from project/API sources
- `document_generated` — Output document was written
- `qsub_type_recommended` — Q-Sub type selected with alternatives (v5.22.0)
- `testing_gap_identified` — Testing gaps found from guidance analysis (v5.22.0)
- `section_applicability_determined` — Section applicability assessed for all 18 sections (v5.22.0)

### Compare-SE Command
- `predicate_inferred` — Predicates inferred from project data
- `table_generated` — SE comparison table created
- `cell_auto_populated` — Table cell auto-filled from FDA data
- `template_selected` — SE template chosen based on product code (v5.22.0)
- `comparison_decision` — Same/Similar/Different breakdown summary (v5.22.0)

### Safety Command
- `safety_query_completed` — MAUDE/recall query finished
- `safety_data_unavailable` — API unavailable, degraded output
- `risk_level_assigned` — Risk level determined with scoring methodology
- `peer_benchmark_completed` — Peer device benchmarking with percentile context

### Extract Command
- `extraction_started` — PDF extraction began
- `extraction_completed` — PDF extraction finished

### Research Command (v5.22.0)
- `predicate_ranked` — Predicate candidates ranked with top-5 and exclusions
- `report_generated` — Research report written with summary metrics

### Pathway Command
- `pathway_recommended` — Pathway selected with scores for all alternatives
- `pathway_alternative_excluded` — Non-chosen pathway with exclusion rationale

### Guidance Command
- `guidance_matched` — Guidance document matched to device
- `guidance_excluded` — Guidance document excluded with reason
- `guidance_trigger_fired` — Cross-cutting trigger activated (tier 1/2/3)

### Test-Plan Command
- `test_prioritized` — Test included in plan with priority rationale
- `test_excluded` — Test excluded with reason (e.g., "Not applicable for non-sterile device")

### Draft Command
- `section_drafted` — Section draft generated with data sources
- `content_decision` — Content choice made when multiple sources conflict

### Consistency Command
- `check_passed` — Consistency check passed
- `check_failed` — Consistency check failed (with expected vs. found)
- `check_warned` — Consistency check warning

### Pre-Check Command
- `pre_check_started` — Pre-check simulation started
- `review_team_identified` — Review team assigned with OHT and specialists
- `rta_screening_completed` — RTA screening finished (pass/fail + item counts)
- `deficiency_identified` — Deficiency found (severity, reviewer, rationale)
- `sri_calculated` — SRI score computed with component breakdown
- `readiness_sri_calculated` — Final readiness score with tier
- `pre_check_report_generated` — Pre-check report written

### Propose Command
- `predicate_proposed` — Predicate manually proposed with validation outcome
- `predicate_validation_result` — Proposal validation completed (pass/fail)

### Agent Actions
- `agent_step_started` — Agent workflow step began
- `agent_step_completed` — Agent workflow step finished
- `agent_decision` — Agent made an autonomous decision

## Parent-Child Linking (v5.22.0)

Use `--parent-entry-id` and `--related-entries` to create cross-command decision chains:

```bash
# Step 1: Log parent decision and capture its entry ID
AUDIT_OUTPUT=$(python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" \
  --project "$PROJECT_NAME" \
  --command presub-planner \
  --action agent_step_started \
  --subject "$PRODUCT_CODE" \
  --decision "started" \
  --mode "pipeline")
PARENT_ID=$(echo "$AUDIT_OUTPUT" | grep "AUDIT_ENTRY_ID:" | cut -d: -f2)

# Step 2: Log child decisions linking back to parent
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" \
  --project "$PROJECT_NAME" \
  --command presub-planner \
  --action qsub_type_recommended \
  --subject "$PRODUCT_CODE" \
  --decision "$QSUB_TYPE" \
  --mode "pipeline" \
  --parent-entry-id "$PARENT_ID"

# Step 3: Link related entries across commands
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" \
  --project "$PROJECT_NAME" \
  --command compare-se \
  --action predicate_inferred \
  --subject "$PREDICATES" \
  --decision "inferred" \
  --mode "auto" \
  --related-entries "$REVIEW_ENTRY_ID,$RESEARCH_ENTRY_ID"
```

In `--show-log` output, parent and related links are displayed below each entry.

## Writing Audit Logs

Commands should append to the audit log using the `fda_audit_logger.py` CLI:

```bash
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" \
  --project "$PROJECT_NAME" \
  --command review \
  --action predicate_accepted \
  --subject K241335 \
  --decision accepted \
  --confidence 85 \
  --mode full-auto \
  --decision-type auto \
  --rationale "Score 85/100, same product code, 3 SE citations" \
  --data-sources "output.csv,openFDA 510k API,openFDA recall API" \
  --alternatives '["K241335","K222222","K111111"]' \
  --exclusions '{"K222222":"Different product code (KGN), score 35","K111111":"Class I recall 2024, score 12"}' \
  --metadata '{"score_breakdown":{"section_context":40,"citation_frequency":15,"product_code_match":15,"recency":10,"regulatory_history":5}}'
```

The logger validates required fields, auto-populates timestamp and version, appends to `audit_log.jsonl`, and prints `AUDIT_STATUS:OK` + `AUDIT_ENTRY_ID`.

For querying:
```bash
# View the full log
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" --project NAME --show-log

# Filter by command and action
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" --project NAME --show-log --command-filter review --action-filter predicate_accepted

# Summary statistics
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" --project NAME --summary

# Pipeline consolidation
python3 "$FDA_PLUGIN_ROOT/scripts/fda_audit_logger.py" --project NAME --consolidate
```

## Pipeline Consolidated Log

At pipeline completion, run `--consolidate` to produce `pipeline_audit.json`:

```json
{
  "pipeline_version": "5.20.0",
  "project": "OVE_2026",
  "started_at": "2026-02-05T12:00:00Z",
  "completed_at": "2026-02-05T12:15:00Z",
  "duration_seconds": 900,
  "steps": {
    "extract": {"status": "completed", "duration_ms": 120000},
    "review": {"status": "completed", "duration_ms": 45000, "accepted": 5, "rejected": 2},
    "safety": {"status": "degraded", "reason": "API timeout"},
    "guidance": {"status": "completed", "duration_ms": 30000},
    "presub": {"status": "completed", "duration_ms": 15000},
    "outline": {"status": "completed", "duration_ms": 20000},
    "compare_se": {"status": "completed", "duration_ms": 60000}
  },
  "total_decisions": 7,
  "auto_decisions": 7,
  "manual_decisions": 0,
  "warnings": ["Safety data degraded — API timeout"],
  "files_generated": [
    "output.csv", "review.json", "presub_plan.md",
    "submission_outline.md", "se_comparison.md"
  ]
}
```
